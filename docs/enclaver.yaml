# Enclaver manifest â€” complete reference (v1)
#
# This file lists all supported configuration fields and documents ingress/egress rules.
# Copy, trim, and edit for your own service. Lines starting with `#` are comments.
#
# Contract
# - Inputs: Docker images, optional signing keys, optional TLS material inside the image.
# - Outputs: A release image that contains an EIF and the manifest; at runtime `odyn` reads this.
# - Errors: Unknown fields are rejected; missing required fields or malformed values fail at build/run.
#
# Notes
# - If `ingress` is omitted, there is no inbound connectivity into the enclave.
# - If `egress.allow` is empty or omitted, egress is entirely disabled and no proxy env vars are set.
# - If you enable `kms_proxy`, ensure egress allows IMDS (169.254.169.254) and your KMS endpoints.
# - Domain allow/deny rules support `*` (single label) and `**` (any suffix). See examples below.
# - IP allow/deny rules support exact IP and CIDR (IPv4/IPv6).
#
# Required top-level fields
version: "v1"                 # Schema version (string). Only "v1" is supported.
name: "your-service"          # Friendly name for your enclave/application (string).
target: "repo/name:tag"       # Release image tag to produce on build (string, e.g., ECR/ Docker Hub tag).

# Source images used during build
sources:
  app: "repo/app:tag"         # REQUIRED. The application image to run inside the enclave.
  # odyn and sleeve may be overridden. If omitted, well-known defaults are pulled.
  # Default odyn:   public.ecr.aws/d4t4u8d2/sparsity-ai/odyn:latest
  # Default sleeve: public.ecr.aws/d4t4u8d2/sparsity-ai/enclaver-wrapper-base:latest
  #odyn: "repo/odyn:tag"
  #sleeve: "repo/sleeve:tag"

# Optional: sign the EIF at build time (keys are read on the host during build)
signature:
  # Paths are resolved relative to the manifest file location.
  certificate: ./path/to/cert.pem   # Path (string). X.509 certificate in PEM
  key: ./path/to/key.pem            # Path (string). Private key in PEM matching the certificate

# Optional defaults used by `enclaver run` when flags are not provided
# If omitted, the runtime defaults are cpu_count=2, memory_mb=4096
defaults:
  cpu_count: 2               # Number of vCPUs to assign to the enclave (int)
  memory_mb: 4096            # Enclave memory in MiB (int)

# Ingress: host->enclave TCP/TLS listeners exposed by odyn inside the enclave
# Each entry binds inside the enclave on the given listen_port and is proxied via host localhost.
# At run time, the host-side runner publishes the same port to the host network as needed.
ingress:
  - listen_port: 8080        # u16 (0-65535). TCP port inside the enclave for your app to listen on
    # Optional TLS for the VSOCK leg (host<->enclave). The app still receives plain TCP on localhost.
    # Runtime expects PEM files at: <config_dir>/tls/server/<listen_port>/{cert.pem,key.pem}
    # By default odyn uses config_dir=/etc/enclaver inside the enclave.
    # The tls fields below exist in the schema but are currently NOT used by odyn at runtime.
    # Odyn always reads from the fixed paths above. These fields may be used by external tooling.
    tls:
      key_file: key.pem      # String. Filename hint (not used by odyn runtime)
      cert_file: cert.pem    # String. Filename hint (not used by odyn runtime)

# Egress: enable a local HTTP(S) proxy inside the enclave with allow/deny policy
# When enabled, odyn sets http_proxy/https_proxy env vars to http://127.0.0.1:<proxy_port>
# and `no_proxy=localhost,127.0.0.1` for the entrypoint process.
egress:
  proxy_port: 10000          # Optional u16. TCP port inside the enclave for the local proxy (default: 10000)
  # Allow and deny take a list of patterns. A request host is allowed iff it matches at least
  # one allow pattern AND does not match any deny pattern. If `allow` is empty/missing, egress is disabled.
  allow:
    # Domain patterns (case-insensitive):
    # - Exact: "example.com" (matches only example.com, not subdomains)
    # - Single-label wildcard: "*.example.com" (matches foo.example.com but NOT bar.foo.example.com)
    # - Multi-label suffix: "**.amazonaws.com" (matches s3.amazonaws.com and a.b.c.amazonaws.com, NOT amazonaws.com apex)
    # IP/CIDR patterns:
    # - Exact IP: "66.254.33.22" (implicit /32)
    # - IPv4 CIDR: "66.254.33.0/24"
    # - IPv6 CIDR: "::/0" (all IPv6)
    - "news.ycombinator.com"
    #- "**"                 # Allow all domains (not recommended for production)
    #- "169.254.169.254"   # IMDS (needed if kms_proxy is enabled)
  deny:
    # Optional block list evaluated after allow. Same grammar as allow.
    #- "*.example.net"
    #- "10.0.0.0/8"

# Optional: local KMS-compatible proxy inside the enclave
# - Listens on HTTP and forwards to AWS KMS using IMDS-derived credentials via egress proxy.
# - Sets AWS_KMS_ENDPOINT=http://127.0.0.1:<listen_port> for the entrypoint process.
# - Requires egress.allow to include 169.254.169.254 (IMDS) and the KMS endpoints used.
kms_proxy:
  listen_port: 9000          # u16 (required). TCP port inside the enclave for the local KMS proxy
  # Optional per-region endpoint overrides (value is host only; scheme/path are set by the proxy)
  # If omitted, defaults to kms.<region>.amazonaws.com
  endpoints:                 # Optional map<string, string>
    us-east-1: kms.us-east-1.amazonaws.com
    #eu-west-1: kms.eu-west-1.amazonaws.com

# Optional: internal API exposed inside the enclave for attestation/health/etc.
api:
  listen_port: 8000          # u16 (required). TCP port inside the enclave for the internal API server

# Examples and tips
# - To expose your app on host port 8080, add an ingress entry with listen_port: 8080 and have your app
#   bind to 127.0.0.1:8080 inside the enclave. The host runner will proxy host:8080 to the enclave.
# - The special hostname "host" can be used by the egress bridge to refer to the host's 127.0.0.1
#   (use with care; this is not a config field, just a runtime behavior of the host bridge).
# - Keep your allow list as narrow as possible. Prefer exact hosts or minimal wildcards.
